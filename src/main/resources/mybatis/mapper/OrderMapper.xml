<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.ysu.model.dao.orderDAO">

    <select id="OrderList" resultType="com.example.ysu.model.dto.orderDTO">
        SELECT * FROM orders where u_id='2023200009' ORDER BY order_id DESC LIMIT 1;
    </select>

    <select id="OrderDetailList" resultType="com.example.ysu.model.dto.orderDTO">
        SELECT d.*, m.menu_name, m.menu_price, m.menu_corner, m.menu_image
        FROM menu m
        JOIN orderDetail d
        ON m.menu_id = d.menu_id
        WHERE d.order_id=#{order_id};

    </select>

    <insert id="OrderInsert" parameterType="com.example.ysu.model.dto.orderDTO">
        INSERT INTO orders (u_id, total_quantity, total_price, order_date)
        SELECT c.u_id, #{total_quantity},  #{total_price}, NOW()
        FROM cart c
        JOIN menu m ON c.menu_id = m.menu_id
        WHERE c.u_id = '2023200009'
        GROUP BY c.u_id;

        INSERT INTO orderDetail (order_id, menu_id, u_id, quantity, price, is_packed)
        SELECT
        IFNULL(MAX(o.order_id), 1) AS order_id,
        c.menu_id,
        c.u_id AS u_id,
        c.quantity AS quantity,
        SUM(CASE WHEN c.is_packed = 1 THEN (m.menu_price + 500) * 1 ELSE m.menu_price * 1 END) AS price,
        MAX(c.is_packed) AS is_packed
        FROM cart c
        JOIN menu m ON c.menu_id = m.menu_id
        JOIN orders o ON o.u_id = c.u_id
        WHERE c.u_id = '2023200009'
        GROUP BY c.u_id, c.menu_id, c.quantity;
    </insert>
</mapper>